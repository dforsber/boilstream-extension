# WASM Integration Tests for opaque-client

## Overview

These integration tests use the **exact same WASM build** that the DuckDB extension uses:
- Target: `wasm32-unknown-emscripten`
- Library: `libopaque_client.a` (static library)
- Same code path as production

**Why this matters:** Testing with `@serenity-kit/opaque` or similar wrappers would test a different WASM target (`wasm32-unknown-unknown`) that's incompatible with C++ linking. These tests verify your actual production code.

---

## Quick Start

### 1. Prerequisites

**Emscripten SDK:**
```bash
# Install Emscripten (if not installed)
git clone https://github.com/emscripten-core/emsdk.git ~/emsdk
cd ~/emsdk
./emsdk install latest
./emsdk activate latest

# Activate for this session
source ~/emsdk/emsdk_env.sh
```

**Verify:**
```bash
emcc --version  # Should show Emscripten version
```

### 2. Build Tests

```bash
# Build Rust WASM library (if not built)
npm run build

# Build integration test
npm run build:integration
```

This compiles `integration-test.c` with Emscripten, linking your `libopaque_client.a`.

**Output:**
- `integration-test.js` - Node.js entry point
- `integration-test.wasm` - Compiled WASM module

### 3. Run Tests

**Option A: Local tests only (no server)**
```bash
npm run test:integration
```

Tests basic OPAQUE operations without hitting a server.

**Option B: Interactive mode (prompts for server details)**
```bash
npm run test:integration:interactive
```

Prompts you for:
- Server URL (e.g., `https://localhost:4332`)
- Bootstrap token

**Option C: Direct configuration**
```bash
node run-integration-test.js --server=https://localhost:4332 --token=YOUR_BOOTSTRAP_TOKEN
```

---

## What Gets Tested

### Level 1: Local Tests (Always Run)
- âœ… OPAQUE registration start (generates registration request)
- âœ… OPAQUE login start (generates credential request)
- âœ… Memory management (no leaks)
- âœ… Error handling (null pointers, invalid inputs)

### Level 2: Server Integration (If Server Configured)
- âœ… Full OPAQUE registration flow with boilstream server
- âœ… Full OPAQUE login flow with boilstream server
- âœ… HTTP communication via Emscripten Fetch API
- âœ… JSON encoding/decoding
- âœ… Base64 encoding/decoding

---

## File Structure

```
opaque-client/test-wasm/
â”œâ”€â”€ integration-test.c              # C test program
â”œâ”€â”€ build-integration-test.sh       # Build script
â”œâ”€â”€ run-integration-test.js         # Node.js test runner
â”œâ”€â”€ integration-test.js             # Generated by emcc
â”œâ”€â”€ integration-test.wasm           # Generated by emcc
â”œâ”€â”€ package.json                    # NPM scripts
â””â”€â”€ INTEGRATION_TEST_README.md      # This file
```

---

## How It Works

### Build Process

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Rust Compilation                                    â”‚
â”‚     cargo build --target wasm32-unknown-emscripten      â”‚
â”‚     â†’ libopaque_client.a                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. C Compilation with Emscripten                       â”‚
â”‚     emcc integration-test.c libopaque_client.a          â”‚
â”‚     â†’ integration-test.js + integration-test.wasm       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Node.js Execution                                   â”‚
â”‚     node integration-test.js                            â”‚
â”‚     â†’ Runs tests, calls Rust FFI via WASM              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Runtime Architecture

```
Node.js Process
    â†“
integration-test.js (Emscripten glue code)
    â†“
integration-test.wasm (WASM module)
    â”œâ”€â”€ C test code
    â”œâ”€â”€ Rust opaque-client library
    â””â”€â”€ OPAQUE-KE crypto operations
    â†“
Emscripten Fetch API â†’ HTTP requests to boilstream server
```

---

## Testing Strategy

### Phase 1: Local Validation âœ…
**Goal:** Verify WASM build works
**Tests:** FFI calls, memory management, basic operations
**No server needed**

### Phase 2: Protocol Validation ğŸ¯ (This)
**Goal:** Verify OPAQUE protocol against real server
**Tests:** Full registration/login flows
**Requires boilstream server**

### Phase 3: DuckDB Integration
**Goal:** Verify in DuckDB WASM
**Tests:** SQL interface, extension loading
**Requires DuckDB WASM build**

---

## Debugging

### Common Issues

**1. "emcc not found"**
```bash
# Activate Emscripten
source ~/emsdk/emsdk_env.sh
```

**2. "libopaque_client.a not found"**
```bash
# Build Rust library first
cd ..
cargo build --target wasm32-unknown-emscripten --release
cd test-wasm
```

**3. "RuntimeError: memory access out of bounds"**
```bash
# Increase memory in build-integration-test.sh
# Change -s TOTAL_MEMORY=67108864 to a larger value
```

**4. "Cannot connect to server"**
```bash
# Check server is running
curl https://localhost:4332/health

# Check SSL/TLS issues
# For local testing, you may need to accept self-signed certificates
```

### Enable Debug Logging

Add to `integration-test.c`:
```c
#define DEBUG 1
```

Rebuild:
```bash
npm run build:integration
```

---

## Comparison: This vs WASM Wrappers

| Feature | This Test | @serenity-kit/opaque |
|---------|-----------|----------------------|
| **WASM Target** | wasm32-unknown-emscripten | wasm32-unknown-unknown |
| **Same as Production** | âœ… Yes | âŒ No |
| **Tests C++ Linking** | âœ… Yes | âŒ No |
| **Easy to Use** | âš ï¸ Moderate | âœ… Very Easy |
| **DuckDB Compatible** | âœ… Yes | âŒ No |
| **Protocol Validation** | âœ… Yes | âœ… Yes |

**Conclusion:** Both are useful, but this test is essential because it validates your actual production code path.

---

## Expected Output

### Successful Local Test

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  OPAQUE Client WASM Integration Test                      â•‘
â•‘  Testing: wasm32-unknown-emscripten Build                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â„¹ This test uses the ACTUAL WASM build used by DuckDB extension
â„¹ Target: wasm32-unknown-emscripten
â„¹ Library: libopaque_client.a (static library)

=== OPAQUE Login Flow - Local Test ===
âœ“ Login started successfully
  Credential request (96 bytes): 1a2b3c4d5e6f...

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Test Summary                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  âœ“ Passed: 1
  âœ— Failed: 0
  ğŸ“Š Total:  1

ğŸ‰ All tests passed! WASM build is working correctly.
```

### Successful Server Integration

```
=== OPAQUE Registration Flow - Against Real Server ===
âœ“ Registration started successfully
  Registration request (96 bytes): a1b2c3d4e5f6...
â„¹ Sending registration request to server...
â„¹ URL: https://localhost:4332/register
âœ“ Server responded to registration request
âœ“ Registration complete

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Test Summary                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  âœ“ Passed: 2
  âœ— Failed: 0
  ğŸ“Š Total:  2

ğŸ‰ All tests passed! WASM build is working correctly.
```

---

## Next Steps

After these tests pass:

1. **âœ… WASM build verified** - Your opaque-client compiles correctly
2. **âœ… Protocol verified** - OPAQUE flows work against server
3. **â³ Test DuckDB extension** - Build full extension for WASM
4. **â³ Test SQL interface** - Verify PRAGMA commands work

---

## Troubleshooting Boilstream Server

If you need to test against a local server:

```bash
# Start boilstream server (adjust for your setup)
cd /path/to/boilstream-server
./start-server.sh

# Or with Docker
docker run -p 4332:4332 boilstream-server

# Verify server is running
curl -k https://localhost:4332/health
```

Get bootstrap token from server logs or admin panel.

---

## CI/CD Integration

Add to your CI pipeline:

```yaml
# .github/workflows/test-wasm.yml
- name: Setup Emscripten
  uses: mymindstorm/setup-emsdk@v12
  with:
    version: 'latest'

- name: Build and Test WASM
  run: |
    cd opaque-client/test-wasm
    npm run build
    npm run build:integration
    npm run test:integration
```

---

## Support

If tests fail, check:
1. âœ… Emscripten activated: `emcc --version`
2. âœ… Rust library built: `ls ../target/wasm32-unknown-emscripten/release/libopaque_client.a`
3. âœ… Test compiled: `ls integration-test.wasm`
4. âœ… Server running (if testing integration): `curl -k https://localhost:4332/health`

---

**Remember:** These tests validate your actual production WASM build. Success here means your DuckDB extension WASM build will work!
