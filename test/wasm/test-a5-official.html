<!DOCTYPE html>
<html>
<head>
  <title>Test Official A5 Extension</title>
  <style>
    body { font-family: monospace; background: #1e1e1e; color: #d4d4d4; padding: 20px; }
    .log { background: #252526; padding: 15px; margin: 10px 0; max-height: 600px; overflow-y: auto; }
    .success { color: #4ec9b0; }
    .error { color: #f48771; }
    .info { color: #4fc1ff; }
  </style>
</head>
<body>
  <h1>Official A5 Extension Test (v1.4.1)</h1>
  <button onclick="runTest()">Run Test</button>
  <div class="log" id="log"></div>

  <script type="module">
    import * as duckdb from 'https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@latest/+esm';

    function log(msg, type = 'info') {
      const logEl = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = type;
      entry.textContent = typeof msg === 'object' ? JSON.stringify(msg, null, 2) : msg;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
    }

    async function runTest() {
      document.getElementById('log').innerHTML = '';
      try {
        log('1. Loading DuckDB WASM...', 'info');
        const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
        const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);

        const workerResponse = await fetch(bundle.mainWorker);
        const workerBlob = await workerResponse.blob();
        const workerUrl = URL.createObjectURL(workerBlob);
        const worker = new Worker(workerUrl);
        const logger = new duckdb.ConsoleLogger(duckdb.LogLevel.WARNING);

        const db = new duckdb.AsyncDuckDB(logger, worker);
        await db.instantiate(bundle.mainModule, bundle.pthreadWorker);
        await db.open({ allowUnsignedExtensions: true });
        const conn = await db.connect();

        const versionResult = await conn.query('SELECT version()');
        const version = versionResult.toArray()[0].version;
        log('DuckDB version: ' + version, 'success');
        log('✓ DuckDB ready', 'success');

        log('');
        log('2. Loading OFFICIAL A5 extension (v1.4.1) from extensions.duckdb.org...', 'info');
        const extensionUrl = 'https://extensions.duckdb.org/v1.4.1/wasm_eh/a5.duckdb_extension.wasm';

        await conn.query(`INSTALL '${extensionUrl}'`);
        log('✓ A5 extension installed', 'success');

        await conn.query(`LOAD '${extensionUrl}'`);
        log('✓ A5 extension loaded!', 'success');

        log('');
        log('3. Testing A5 function: a5_cell_area(10)...', 'info');
        const result = await conn.query('SELECT a5_cell_area(10) as area');
        const rows = result.toArray();
        log('Result: ' + JSON.stringify(rows), 'success');

        if (rows.length > 0 && rows[0].area) {
          log('');
          log('✅ SUCCESS: A5 extension works perfectly in WASM!', 'success');
          log('The function registered successfully and returned: ' + rows[0].area, 'success');
        } else {
          throw new Error('Function did not return expected result');
        }

      } catch (error) {
        log('', 'error');
        log('❌ ERROR: ' + error.message, 'error');
        if (error.stack) {
          log(error.stack, 'error');
        }
      }
    }

    window.runTest = runTest;
    log('Ready. Click "Run Test" to test official A5 extension.', 'info');
  </script>
</body>
</html>
