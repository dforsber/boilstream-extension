<!DOCTYPE html>
<html>
<head>
  <title>Test A5 Extension in WASM</title>
  <style>
    body { font-family: monospace; background: #1e1e1e; color: #d4d4d4; padding: 20px; }
    .log { background: #252526; padding: 15px; margin: 10px 0; max-height: 600px; overflow-y: auto; }
    .success { color: #4ec9b0; }
    .error { color: #f48771; }
  </style>
</head>
<body>
  <h1>A5 Extension Test</h1>
  <button onclick="runTest()">Run Test</button>
  <div class="log" id="log"></div>

  <script type="module">
    import * as duckdb from 'https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@latest/+esm';

    function log(msg, type = 'info') {
      const logEl = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = type;
      entry.textContent = typeof msg === 'object' ? JSON.stringify(msg, null, 2) : msg;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
    }

    async function runTest() {
      document.getElementById('log').innerHTML = '';
      try {
        log('1. Loading DuckDB WASM...');
        const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
        const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);

        const workerResponse = await fetch(bundle.mainWorker);
        const workerBlob = await workerResponse.blob();
        const workerUrl = URL.createObjectURL(workerBlob);
        const worker = new Worker(workerUrl);
        const logger = new duckdb.ConsoleLogger(duckdb.LogLevel.WARNING);

        const db = new duckdb.AsyncDuckDB(logger, worker);
        await db.instantiate(bundle.mainModule, bundle.pthreadWorker);
        await db.open({ allowUnsignedExtensions: true });
        const conn = await db.connect();

        // Check DuckDB version
        const versionResult = await conn.query('SELECT version()');
        const version = versionResult.toArray()[0].version;
        log('DuckDB version: ' + version);
        log('✓ DuckDB ready', 'success');

        log('');
        log('2. Checking what extensions are available...');

        // Try to list available extensions
        try {
          const extListResult = await conn.query("SELECT * FROM duckdb_extensions() WHERE installed = true");
          const installedExts = extListResult.toArray();
          log('Installed extensions:');
          log(installedExts.map(e => e.extension_name));
        } catch (e) {
          log('Could not list extensions: ' + e.message, 'error');
        }

        log('');
        log('3. Attempting to test a built-in function instead...');
        log('Testing: json_extract...');
        try {
          const result = await conn.query("SELECT json_extract('{\"a\": 1}', '$.a') as result");
          const rows = result.toArray();
          log('Result:', 'success');
          log(rows);
          log('✅ Built-in json functions work (json extension is statically linked)', 'success');
        } catch (e) {
          log('JSON function failed: ' + e.message, 'error');
        }

      } catch (error) {
        log('❌ ERROR: ' + error.message, 'error');
        log(error.stack, 'error');
      }
    }

    window.runTest = runTest;
    log('Ready. Click "Run Test" to test A5 extension.');
  </script>
</body>
</html>
